<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Write yourself a toolchain using LLVM</title>
    <style>
      @import url(https://fonts.googleapis.com/css?family=Source+Code+Pro);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono);
      @import url(https://fonts.googleapis.com/css?family=Inconsolata);

      body {
        font-family: 'Source Code Pro';
      }
      h1, h2, h3 {
        font-family: 'Inconsolata';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-scaler {
        background-color: transparent;
        overflow: hidden;
        position: absolute;
        -webkit-transform-origin: top left;
        -moz-transform-origin: top left;
        transform-origin: top-left;
        -moz-box-shadow: 0 0 0px #111;
        -webkit-box-shadow: 0 0 0px #111;
        box-shadow: 0 0 0px #111;
      }
      .remark-slides-area { background: #111111; }
      .remark-slide-content h1 { font-size: 2.8em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .remark-code { text-align: left; }
      .remark-code-line-highlighted {
        background: rgba(168, 0, 0, 0.4);
        -moz-box-shadow: 0 0 8px #111;
        -webkit-box-shadow: 0 0 8px #111;
        box-shadow: 0 0 8px #111;
      }
      .footnote {
        position: absolute;
        bottom: 3em;
        font-size: 9pt;
      }
      a, a > code {
        color: #cc6666;
        text-decoration: none;
      }
      code {
        border-radius: 8px;
        font-family: 'Ubuntu Mono';
      }
      .inverse {
        background: #111111;
        color: #cfcfcf;
        text-shadow: 0 0 5px #000;
        position: left;
      }
      .inverse h1, .inverse h2 {
        color: #c5c8c6;
        line-height: 0.8em;
      }

      /* Slide-specific styling */
      #slide-inverse .footnote {
        bottom: 12px;
        left: 20px;
      }
      #slide-how .slides {
        font-size: 0.9em;
        position: absolute;
        top:  151px;
        right: 140px;
      }
      #slide-how .slides h3 {
        margin-top: 0.2em;
      }
      #slide-how .slides .first, #slide-how .slides .second {
        padding: 1px 20px;
        height: 90px;
        width: 120px;
        -moz-box-shadow: 0 0 10px #777;
        -webkit-box-shadow: 0 0 10px #777;
        box-shadow: 0 0 10px #777;
      }
      #slide-how .slides .first {
        background: #fff;
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 1;
      }
      #slide-how .slides .second {
        position: relative;
        background: #fff;
        z-index: 0;
      }
      li {
        text-align: left;
      }
      .clangcfg img {
        max-width: 75%;
      }
      .selectiondag img {
        max-width: 63%;
      }
      .selectiondagmodified img {
        max-width: 50%;
      }

      .mcinst {
        margin: 0 auto;
        max-width: 53%;
      }
      .asmprinter {
        margin: 0 auto;
        max-width: 80%;
      }
      .twitter * {
        color: #00aced;
        font-size: 10pt;
      }
      .llvm img {
        max-width:25%;
      }
      .urls {
        padding-bottom: 10px;
      }
      .urls * {
        font-size: 10pt;
        text-align: center;
      }

    </style>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, inverse
---
class: middle, center, inverse
# Write yourself a toolchain using LLVM

.llvm[![LLVM](sources/llvm.png)]

##### Francis Visoiu Mistrih - <francis@lse.epita.fr>

---

class: middle, center, inverse

# LLVM

#### Collection of libraries

#### Releases libraries

#### Expose APIs to every stage of the compiler

#### Rarely care about backward compatibility

---

class: top, center, inverse

# Toolchain

### Compilation - cc1

--

### Assembly - as

--

### Linking - ld

--

### Runtime - builtins / libc

---

class: top, center, inverse

# Compilation

### Lexing

--

### Parsing

--

### Semantic analysis

--

### Intermediate representation

--

### IR optimizations

--

### Instruction selection

--

### Register allocation

---

class: top, center, inverse

# Assembly

### Parsing

--

### Encoding

--

# Linking

### Collect object files

--

### Generate sections (.plt, .dynamic, ...)

--

### Merge sections

--

### Fix relocations

---

class: top, center, inverse

# Runtime

### Builtins

--

### libc

--

### Sanitizers

---

class: top, center, inverse

# The LLVM Compiler Infrastructure

--

### LLVM Core

--

### Clang

--

### LLD

--

### LLDB

--

#### libc++

--

#### compiler-rt

---
class: middle, center, inverse

# Let's add our target!

#### Clang - LLVM -> LLD

---
class: top, center, inverse

## Clang

Target informations:

```center
Pointer width, pointer align, size_t / ptrdirr_t types, endianness, etc.
```

--

CPP defines:

```center
__TARGET__, __ELF_, __APPLE__, __x86__, etc.
```

--

`ld.so` / ELF:

```center
loader, ELF32 / ELF64, etc.
```

---
class: top, center, inverse

## LLVM Core

#### Registers:

```center
registers, callee saved, caller saved, fp, sp, reserved, etc.
```

--

#### Instructions:

```center
opcode, encoding, in / out regs, IR pattern, string, isBranch, sideEffects, etc.
```

--

#### Calling conventions:

```center
argument passing, result value, stack alignment, argument types, etc.
```

--

#### Relocations:

```center
symbols, relocation generation, ELF definitions, etc.
```

---
class: top, center, inverse

## LLVM Core

#### Lowering:

```center
expand instructions, copy arguments to registers, stack management, etc.
```

--

#### Legalization:

```center
legal types, legal instructions, expand illegal instructions etc.
```

--

#### Target-specific passes:

```center
compute delay slots, optimize addressing mode, etc.
```

---
class: top, center, inverse

## LLD

#### ELF:

```center
ELF arch, target info, etc.
```

--

#### Relocations:

```center
relocation type, position independent, relocation action, relocation name, etc.
```

---

class: top, center, inverse

# J-Core

--

### SH2 ISA

--

### Hitachi SuperH - Sega Saturn

### Different models: SH2 <-> J2, SH3 <-> J3, etc.

### ARM Thumb's inspiration

--

### Open source

### VHDL implementation

---
class: top, center, inverse

# J2

### 5-stage RISC

--

### 16-bit instructions

#### 133 instructions

--

### 32-bit registers

#### 16 general purpose registers

#### 1 64-bit register

---

class: middle, center, inverse

# How to start

#### Add the target to LLVM / Clang / LLD

##### Unlike GCC, you don't need to build a cross-compiler

##### Describe your target and the subtargets

---

class: middle, center, inverse

# Registers

```tablegen
def R0 : J2Reg<0, "r0">, DwarfRegNum<[ 0 ]>;

[...]

def R15 : J2Reg<15, "r15", [ "sp" ]>, DwarfRegNum<[ 15 ]>;
```

Register classes

```tablegen
def GPR : RegisterClass<"J2", [ i32 ], 32, (add R0, [...], R15)>;
```

Reserved registers

---

class: middle, center, inverse

# Instructions

## Instruction formats

```center
15                          0                             
----------------------------- x: opcode                   
|      |      |      |      | n : src                     
| xxxx | nnnn | mmmm | xxxx |                             
|      |      |      |      | m : dst                     
----------------------------- x: instruction-specific data
```

--

```tablegen
class FNM<bits<4> op, bits<4> data, dag outs, dag ins, string asmstr,
          list<dag> pattern> {

    bits<4> dst;
    bits<4> src;

    let Inst{15 - 12} = op;
    let Inst{11 - 8} = dst;
    let Inst{7 - 4} = src;
    let Inst{3 - 0} = data;
}
```

---

class: middle, center, inverse

## my_first_instruction

```center
add r0, r14
```

--

#### RTFM

```center
add Rm,Rn                        Rm + Rn -> Rn                    0011nnnnmmmm1100
```

---

class: middle, center, inverse

```center
add Rm,Rn                        Rm + Rn -> Rn                    0011nnnnmmmm1100
```

```tablegen
let                 ,                            ,           in {
  def ADDrr :    <   ,    , (outs         ), (ins                  ),
                  "             ",
                  [ (                                     ) ]>;
```

---

class: middle, center, inverse

```center
add Rm,Rn                        Rm + Rn -> Rn                    0011nnnnmmmm1100
```

```tablegen
let                 , Constraints = "$rnd = $rns",           in {
  def ADDrr :    <   ,    , (outs GPR:$rnd), (ins GPR:$rm, GPR:$rns),
                  "             ",
                  [ (                                     ) ]>;
```

---

class: middle, center, inverse

```center
add Rm,Rn                        Rm + Rn -> Rn                    0011nnnnmmmm1100
```

```tablegen
let                 , Constraints = "$rnd = $rns",           in {
  def ADDrr :    <   ,    , (outs GPR:$rnd), (ins GPR:$rm, GPR:$rns),
                  "add $rm, $rnd",
                  [ (                                     ) ]>;
```
---

class: middle, center, inverse

```center
add Rm,Rn                        Rm + Rn -> Rn                    0011nnnnmmmm1100
```

```tablegen
let                 , Constraints = "$rnd = $rns",           in {
  def ADDrr :    <   ,    , (outs GPR:$rnd), (ins GPR:$rm, GPR:$rns),
                  "add $rm, $rnd",
                  [ (set i32:$rnd, (add i32:$rm, i32:$rns)) ]>;
```
---

class: middle, center, inverse

```center
add Rm,Rn                        Rm + Rn -> Rn                    0011nnnnmmmm1100
```

```tablegen
let                 , Constraints = "$rnd = $rns",           in {
  def ADDrr : FNM<0x3, 0xC, (outs GPR:$rnd), (ins GPR:$rm, GPR:$rns),
                  "add $rm, $rnd",
                  [ (set i32:$rnd, (add i32:$rm, i32:$rns)) ]>;
```
---

class: middle, center, inverse

```center
add Rm,Rn                        Rm + Rn -> Rn                    0011nnnnmmmm1100
```

```tablegen
let isCommutable = 1, Constraints = "$rnd = $rns", isAdd = 1 in {
  def ADDrr : FNM<0x3, 0xC, (outs GPR:$rnd), (ins GPR:$rm, GPR:$rns),
                  "add $rm, $rnd",
                  [ (set i32:$rnd, (add i32:$rm, i32:$rns)) ]>;
```

---

class: middle, center, inverse

### What is actually generated

##### J2GenAsmMatcher.inc - AsmParser

```c++
static const MatchEntry MatchTable0[] = {
  { 0 /*add*/, J2::ADDrr, Convert_Reg1_1_Reg1_0_Tie0, 0, { MCK_GPR, MCK_GPR }, },
```

##### J2GenAsmWriter.inc - AsmPrinter

```c++
case 2:
  // ADDrr
  printOperand(MI, 1, O);
  O << ", ";
  printOperand(MI, 0, O);
  return;
  break;
```

---

class: middle, center, inverse

### What is actually generated

##### J2GenDisassemblerTables.inc - Disassembler

```c++
static const uint8_t DecoderTable16[] = {
  /* 221 */     MCD::OPC_Decode, 83, 4, // Opcode: ADDrr
```

##### J2GenMCCodeEmitter.inc - Assembler

```c++
case J2::ADDrr:
  // op: src
  op = getMachineOpValue(MI, MI.getOperand(0), Fixups, STI);
  Value |= (op & UINT64_C(15)) << 4;
  // op: dst
  op = getMachineOpValue(MI, MI.getOperand(1), Fixups, STI);
  Value |= (op & UINT64_C(15)) << 8;
  break;
```

---

class: middle, center, inverse

### What is actually generated

##### J2GenDAGISel.inc - Instruction selection

```c++
static const unsigned char MatcherTable[] = {
/*670*/         OPC_MorphNodeTo1, TARGET_VAL(J2::ADDrr), 0,
                    MVT::i32, 2/*#Ops*/, 0, 1,
                // Src: (add:i32 i32:i32:$rm, i32:i32:$rns) - Complexity = 3
                // Dst: (ADDrr:i32 i32:i32:$rm, i32:i32:$rns)
/*678*/       0, /*End of Scope*/
```

##### J2GenInstrInfo.inc - Instruction information

```c++
namespace J2 {
  enum {
    ANDrr = 83,
```

```c++
  { 83, 3,  1,  2,  0,  0|(1ULL<<MCID::Add)|(1ULL<<MCID::Commutable), 0x0ULL,
    nullptr, nullptr, OperandInfo22, -1 ,nullptr },  // Inst #83 = ADDrr
```

---

class: middle, center, inverse

# Code generation

---

class: top, center, inverse

# Code generation

### Calling convention lowering

```tablegen
def CC_J2 : CallingConv<[
  CCIfType<[ i1, i8, i16 ], CCPromoteToType<i32>>,
  CCIfType<[ i32 ], CCAssignToReg<[ R4, R5, R6, R7 ]>>,
  CCIfType<[ i32 ], CCAssignToStack<4, 4>> // 4 bytes size, 4 bytes alignment.
+]>;
```

--

#### Ask calling convention what to do

#### Generate target-specific instructions

#### J2-specific: move arguments to registers

---

class: top, center, inverse

# Code generation

### Frame lowering

--

class: top, center, inverse

##### Prologue / Epilogue

```asm
mov.l r14, @r15			 ; push $fp
mov r15, r14				; $sp = $fp
add #-8, r15				; $sp -= 8
[...]
mov r14, r15				; $fp = $sp
mov.l @14, r14			  ; pop $fp
rts						 ; return
```

##### Callee save / regalloc spilling

* storeRegToStackSlot

* loadRegFromStackSlot

---

class: top, center, inverse

# Code generation

### Relocations

#### Generate relocations for unknown symbols

```tablegen
def BSR : FD12<0xB, (outs), (ins j2CallTarget:$target),
               "bsr $target",
               [ (call tglobaladdr:$target) ]>;
```

--

##### Add fixups to the final object file

```c++
unsigned J2MCCodeEmitter::getMachineOpValue(...) {
  [...]
  auto Fixup = MCFixup::create(0, MO.getExpr(), J2::fixup_J2_BSR, MI.getLoc());
  Fixups.push_back();
}
```

---

class: top, center, inverse

# Code generation

### Relocations

#### Fixups are lowered to ELF relocations

```c
int foo(int);
int bar(int a) { return foo(a); }
```

```shell
$ clang -target j2-unknown-linux-gnu -fintegrated-as -nostdlib call.c -c -S
$ cat call.s
```
```asm
bar:
				  mov.l	r14, @r15
				  [...]
				  bsr	  foo
```

---

class: top, center, inverse

# Code generation

### Relocations

#### Fixups are lowered to ELF relocations

```c
int foo(int);
int bar(int a) { return foo(a); }
```

```shell
$ clang -target j2-unknown-linux-gnu -fintegrated-as -nostdlib call.c -c
$ llvm-objdump -d call.o
```
```asm
bar:
0x0:	e2 2f 	mov.l	r14, @r15
[...]
0xc:	00 b0 	bsr	  #0
```

```
$ llvm-objdump -t -r call.o
RELOCATION RECORDS FOR [.rela.text]:
0000000c R_J2_BSR Unknown
```

---
class: middle, center, inverse

#### References

.urls[
https://github.com/thegameg/j2-llvm

http://llvm.org/docs/WritingAnLLVMBackend.html

http://www.shared-ptr.com/sh_insns.html
]

## Any questions?

##### <francis@lse.epita.fr>

.twitter[[@thegameg](https://twitter.com/thegameg)]

.footnote[Slideshow created using [remark](http://github.com/gnab/remark).]
    </textarea>
    <script src="vendor/remark.js"></script>
    <script>
      var hljs = remark.highlighter.engine;
    </script>
    <script>
      var slideshow = remark.create({
          highlightStyle: 'tomorrow-night',
          highlightLanguage: 'c++',
          highlightLines: true
        }) ;
    </script>
  </body>
</html>
